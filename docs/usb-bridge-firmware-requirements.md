# USB ブリッジファームウェア要件定義書

## 目的
ESP32 上で実行する USB ブリッジ用ファームウェアの要件を整理し、cgminer から bitaxe Gamma の ASIC を USB 経由で制御可能にすることを目的とします。

## 範囲
- 対象ハードウェア: bitaxe Gamma など ESP32 + BM1370 を搭載したボード
- 対象ソフトウェア: `firmware/usb-bridge` ディレクトリで管理する ESP-IDF プロジェクト
- ホスト環境: Raspberry Pi 3B+ など Linux マシン上で動作する cgminer

## 機能要件
1. **USB CDC-ACM デバイスとして認識**
   - ホストからは `/dev/ttyACM*` として見えること
   - 通信速度は 115200 bps、8N1 を基本とする
2. **プロトコルの実装**
   - `raspi3bplus-bitaxegamma-protocol.md` で定義したパケット形式を使用
   - `HELLO` でファームウェアバージョンを返し、`WORK` で受信したブロックヘッダを ASIC へ転送
   - 計算結果は `RESULT` パケットとして返送する
   - 異常時は `ERROR` パケットを返す
3. **ASIC 制御**
   - BM1370 への SPI 信号タイミングは `reference/ESP-Miner` の実装を参考にする
   - 周波数設定やリセット処理を行う API を提供する
4. **ロギング**
   - USB シリアル経由でデバッグログを出力できること
   - ログレベルをビルド時に切り替え可能とする
5. **ファームウェア更新**
   - ESP-IDF 標準の OTA 機構を利用し、将来的な更新に備える

## 非機能要件
1. ESP-IDF v4.4 以降でビルド可能であること
2. ビルド後のバイナリサイズは 1MB 以内を目標とする
3. 長時間稼働を想定し、メモリリークや例外で停止しないこと
4. ソースコードは `firmware/usb-bridge` 以下で管理し、README にビルド手順を記載する

## 制約
- ESP32 の USB-OTG 機能を利用するため、使用するボードが USB 対応ピン配置であること
- ホスト側 cgminer との互換性を保つため、プロトコル変更時は必ずドライバー側も更新すること

