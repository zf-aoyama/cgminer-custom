# ESP32 USB Bridge Protocol

このドキュメントでは、bitaxe Gamma を USB 接続で制御するための ESP32 側ファームウェアが実装すべきシリアル通信プロトコルの概要を定義します。

## 基本方針
- Raspberry Pi 側では USB CDC ACM デバイスとして認識されるシリアルポート `/dev/ttyACM*` を想定します。
- 通信は 115200bps の 8N1 を基本とし、バイナリパケットを利用します。

## パケット形式
各パケットは以下のフォーマットで構成されます。

| Offset | 内容 | 説明 |
|-------:|------|------|
| 0      | 0xAA | パケット開始バイト |
| 1      | type | コマンド種別 |
| 2..3   | len  | 後続データ長 (リトルエンディアン) |
| 4..(4+len-1) | data | ペイロード |
| 末尾   | 0x55 | パケット終了バイト |

`type` には以下を定義します。

- `0x01` : ハンドシェイク要求 (`HELLO`)
- `0x02` : ワークデータ送信 (`WORK`)
- `0x03` : 結果要求 (`RESULT`)
- `0x10` : エラーレスポンス (`ERROR`)

## 通信フロー例
1. ホスト (cgminer) が `HELLO` パケットを送信。デバイスは `HELLO` 応答としてファームウェアバージョンを返す。
2. ホストが `WORK` パケットで 80 バイトのブロックヘッダおよびターゲットを送信。
3. デバイスは ASIC へハッシュ計算を指示し、完了時に `RESULT` パケットで nonce を返す。nonce が見つからない場合は空の `RESULT` を定期的に返す。
4. エラーが発生した場合は `ERROR` パケットで理由を通知する。

## 参考実装
ESP-IDF 上では `tinyusb` の CDC ACM クラスを使用してシリアルデバイスを実装します。受信したパケットは上記フォーマットで解析し、ASIC ドライバへ処理を委譲します。ASIC との SPI 通信部分は `reference/ESP-Miner` のコードを流用可能です。

